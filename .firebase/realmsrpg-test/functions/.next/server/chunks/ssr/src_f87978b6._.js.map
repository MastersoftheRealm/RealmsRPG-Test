{"version":3,"sources":["../../../../src/components/layout/index.ts","../../../../src/components/layout/footer.tsx","../../../../src/lib/id-constants.ts","../../../../src/lib/calculators/power-calc.ts","../../../../src/lib/calculators/technique-calc.ts","../../../../src/lib/calculators/item-calc.ts"],"sourcesContent":["/**\n * Layout Components\n * ==================\n * Barrel export for layout components\n */\n\nexport { Header } from './header';\nexport { Footer } from './footer';\nexport { ProtectedRoute } from './protected-route';\r\n","/**\n * Footer Component\n * =================\n * Site-wide footer matching vanilla site design\n */\n\nimport Link from 'next/link';\n\nexport function Footer() {\n  return (\n    <footer className=\"w-full bg-gray-400 border-t border-[#707070] h-10 flex items-center justify-center mt-auto\">\n      <div className=\"w-full max-w-[1440px] px-4 sm:px-6 lg:px-24 flex items-center justify-between\">\n        <Link \n          href=\"/terms\" \n          className=\"font-semibold text-lg text-gray-800 hover:text-gray-900 transition-colors whitespace-nowrap\"\n        >\n          Terms of Service\n        </Link>\n        <Link \n          href=\"/privacy\" \n          className=\"font-semibold text-lg text-gray-800 hover:text-gray-900 transition-colors whitespace-nowrap\"\n        >\n          Privacy Policy\n        </Link>\n        <a \n          href=\"mailto:RealmsRoleplayGame@gmail.com\" \n          className=\"font-semibold text-lg text-gray-800 hover:text-gray-900 transition-colors whitespace-nowrap\"\n        >\n          Contact\n        </a>\n        <a \n          href=\"https://discord.gg/Dbd5X9FQFJ\" \n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"font-semibold text-lg text-gray-800 hover:text-gray-900 transition-colors whitespace-nowrap\"\n        >\n          Discord\n        </a>\n      </div>\n    </footer>\n  );\n}\n","/**\r\n * ID Constants for RealmsRPG Database Entities\r\n * =============================================\r\n * Centralized mapping of database entity IDs.\r\n * Use these instead of hardcoded names for lookups.\r\n */\r\n\r\n// =============================================================================\r\n// PART IDS (Power & Technique Parts)\r\n// =============================================================================\r\n\r\nexport const PART_IDS = {\r\n  // Damage Types\r\n  TRUE_DAMAGE: 1,\r\n  ADDITIONAL_DAMAGE: 6,\r\n  SPLIT_DAMAGE_DICE: 5,\r\n\r\n  // Action Modifiers (Technique)\r\n  REACTION: 2,\r\n  LONG_ACTION: 3,\r\n  QUICK_OR_FREE_ACTION: 4,\r\n\r\n  // Action Modifiers (Power)\r\n  POWER_REACTION: 82,\r\n  POWER_LONG_ACTION: 81,\r\n  POWER_QUICK_OR_FREE_ACTION: 83,\r\n\r\n  // Weapon/Attack Parts\r\n  ADD_WEAPON_ATTACK: 7,\r\n  RECKLESS: 8,\r\n  PASS_THROUGH: 9,\r\n  SPIN: 10,\r\n  STUN: 11,\r\n  WIND_UP: 12,\r\n  KNOCKBACK: 13,\r\n  SLOW: 14,\r\n  DAZE: 15,\r\n  WIDE_SWING: 16,\r\n  ENEMY_STRENGTH_REDUCTION: 17,\r\n  REACH: 18,\r\n  EXPOSE: 19,\r\n  ENEMY_ATTACK_REDUCTION: 20,\r\n  BLEED: 21,\r\n\r\n  // Area of Effect Parts\r\n  LINE_OF_EFFECT: 88,\r\n  CONE_OF_EFFECT: 89,\r\n  CYLINDER_OF_EFFECT: 231,\r\n  SPHERE_OF_EFFECT: 232,\r\n  TRAIL_OF_EFFECT: 233,\r\n  PIERCE_TARGETS_ON_PATH: 234,\r\n  ADD_MULTIPLE_TARGETS: 235,\r\n  EXPANDING_AREA_OF_EFFECT: 236,\r\n  TARGET_ONE_IN_AREA: 237,\r\n  EXCLUDE_AREA: 238,\r\n\r\n  // Power Range\r\n  POWER_RANGE: 292,\r\n\r\n  // Duration Parts\r\n  DURATION_ROUND: 289,\r\n  DURATION_MINUTE: 290,\r\n  DURATION_HOUR: 291,\r\n  DURATION_DAYS: 293,\r\n  DURATION_PERMANENT: 294,\r\n} as const;\r\n\r\n// =============================================================================\r\n// PROPERTY IDS (Item Properties)\r\n// =============================================================================\r\n\r\nexport const PROPERTY_IDS = {\r\n  // General / Base Properties\r\n  DAMAGE_REDUCTION: 1,\r\n  ARMOR_STRENGTH_REQUIREMENT: 2,\r\n  ARMOR_AGILITY_REQUIREMENT: 3,\r\n  ARMOR_VITALITY_REQUIREMENT: 4,\r\n  AGILITY_REDUCTION: 5,\r\n  WEAPON_STRENGTH_REQUIREMENT: 6,\r\n  WEAPON_AGILITY_REQUIREMENT: 7,\r\n  WEAPON_VITALITY_REQUIREMENT: 8,\r\n  WEAPON_ACUITY_REQUIREMENT: 9,\r\n  WEAPON_INTELLIGENCE_REQUIREMENT: 10,\r\n  WEAPON_CHARISMA_REQUIREMENT: 11,\r\n  SPLIT_DAMAGE_DICE: 12,\r\n  RANGE: 13,\r\n  TWO_HANDED: 14,\r\n  SHIELD_BASE: 15,\r\n  ARMOR_BASE: 16,\r\n  WEAPON_DAMAGE: 17,\r\n\r\n  // Combat Properties\r\n  DAMAGE_TYPE_RESISTANCE: 18,\r\n  BLUDGEONING_VULNERABILITY: 19,\r\n  PIERCING_VULNERABILITY: 20,\r\n  SLASHING_VULNERABILITY: 21,\r\n  CRITICAL_RANGE_PLUS_1: 22,\r\n  CRITICAL_RANGE: 23,\r\n  CRITICAL_MULTIPLIER: 24,\r\n  THROWN: 25,\r\n  FINESSE: 26,\r\n  DAMAGED: 27,\r\n  GRAZE: 28,\r\n  LOADING: 29,\r\n  KNOCKBACK: 30,\r\n  WOUNDING: 31,\r\n  SLOW: 32,\r\n  TOPPLE: 33,\r\n  EXPOSE: 34,\r\n  CHARGING: 35,\r\n  HIDDEN: 36,\r\n  AMMUNITION: 37,\r\n  BLEED: 38,\r\n  SHIELD_AMOUNT: 39,\r\n  SHIELD_DAMAGE: 40,\r\n  REACH: 41,\r\n  MOUNTED: 42,\r\n  VERSATILE: 43,\r\n  CLEAVE: 44,\r\n  INTERCHANGEABLE: 45,\r\n  BLOCK: 46,\r\n  QUICK: 47,\r\n  PULL: 48,\r\n} as const;\r\n\r\n// General property IDs excluded from selectable property iterations\r\nexport const GENERAL_PROPERTY_IDS: Set<number> = new Set([\r\n  PROPERTY_IDS.SHIELD_BASE,\r\n  PROPERTY_IDS.ARMOR_BASE,\r\n  PROPERTY_IDS.RANGE,\r\n  PROPERTY_IDS.TWO_HANDED,\r\n  PROPERTY_IDS.SPLIT_DAMAGE_DICE,\r\n  PROPERTY_IDS.DAMAGE_REDUCTION,\r\n  PROPERTY_IDS.WEAPON_DAMAGE,\r\n  PROPERTY_IDS.AGILITY_REDUCTION,\r\n  PROPERTY_IDS.WEAPON_STRENGTH_REQUIREMENT,\r\n  PROPERTY_IDS.WEAPON_AGILITY_REQUIREMENT,\r\n  PROPERTY_IDS.WEAPON_VITALITY_REQUIREMENT,\r\n  PROPERTY_IDS.WEAPON_ACUITY_REQUIREMENT,\r\n  PROPERTY_IDS.WEAPON_INTELLIGENCE_REQUIREMENT,\r\n  PROPERTY_IDS.WEAPON_CHARISMA_REQUIREMENT,\r\n  PROPERTY_IDS.ARMOR_STRENGTH_REQUIREMENT,\r\n  PROPERTY_IDS.ARMOR_AGILITY_REQUIREMENT,\r\n  PROPERTY_IDS.ARMOR_VITALITY_REQUIREMENT,\r\n]);\r\n\r\n// General property names for backwards compatibility\r\nexport const GENERAL_PROPERTY_NAMES = new Set([\r\n  'Shield Base', 'Armor Base', 'Range', 'Two-Handed',\r\n  'Split Damage Dice', 'Damage Reduction', 'Weapon Damage',\r\n  'Agility Reduction',\r\n  'Weapon Strength Requirement', 'Weapon Agility Requirement', 'Weapon Vitality Requirement',\r\n  'Weapon Acuity Requirement', 'Weapon Intelligence Requirement', 'Weapon Charisma Requirement',\r\n  'Armor Strength Requirement', 'Armor Agility Requirement', 'Armor Vitality Requirement',\r\n]);\r\n\r\n// =============================================================================\r\n// Database Lookup Utilities\r\n// =============================================================================\r\n\r\nexport interface HasIdAndName {\r\n  id?: string | number;\r\n  name?: string;\r\n}\r\n\r\n/**\r\n * Find an entity in a database by ID or name.\r\n * Tries ID first, then falls back to name for backwards compatibility.\r\n */\r\nexport function findByIdOrName<T extends HasIdAndName>(\r\n  db: T[],\r\n  ref: { id?: number | string; name?: string }\r\n): T | undefined {\r\n  if (!Array.isArray(db) || !ref) return undefined;\r\n\r\n  // First try by ID\r\n  if (ref.id !== undefined && ref.id !== null) {\r\n    const byId = db.find((item) => {\r\n      const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : item.id;\r\n      const refId = typeof ref.id === 'string' ? parseInt(ref.id, 10) : ref.id;\r\n      return itemId === refId;\r\n    });\r\n    if (byId) return byId;\r\n  }\r\n\r\n  // Fallback to name for backwards compatibility\r\n  if (ref.name) {\r\n    return db.find((item) => item.name === ref.name);\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Find an entity by ID or name string value.\r\n * Handles both numeric IDs and string names.\r\n */\r\nexport function findByIdOrNameValue<T extends HasIdAndName>(\r\n  db: T[],\r\n  idOrName: number | string\r\n): T | undefined {\r\n  if (!Array.isArray(db) || idOrName === undefined || idOrName === null) {\r\n    return undefined;\r\n  }\r\n\r\n  // If it's a number, treat as ID\r\n  if (typeof idOrName === 'number') {\r\n    return db.find((item) => {\r\n      const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : item.id;\r\n      return itemId === idOrName;\r\n    });\r\n  }\r\n\r\n  // If it's a string that looks like a number, try as ID first\r\n  if (typeof idOrName === 'string') {\r\n    const numId = parseInt(idOrName, 10);\r\n    if (!isNaN(numId)) {\r\n      const byId = db.find((item) => {\r\n        const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : item.id;\r\n        return itemId === numId;\r\n      });\r\n      if (byId) return byId;\r\n    }\r\n    // Fallback to name match\r\n    return db.find((item) => item.name === idOrName);\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Normalize a reference to always have an ID.\r\n * For backwards compatibility with old saves that only have names.\r\n */\r\nexport function normalizeRef<T extends HasIdAndName>(\r\n  db: T[],\r\n  ref: HasIdAndName\r\n): HasIdAndName {\r\n  if (!ref) return ref;\r\n\r\n  const found = findByIdOrName(db, ref);\r\n  if (found && found.id !== undefined && found.name) {\r\n    return { ...ref, id: found.id, name: found.name };\r\n  }\r\n\r\n  return ref;\r\n}\r\n\r\n/**\r\n * Convert a parts/properties array to use IDs instead of names.\r\n */\r\nexport function normalizeRefsArray<T extends HasIdAndName>(\r\n  items: HasIdAndName[],\r\n  db: T[]\r\n): HasIdAndName[] {\r\n  if (!Array.isArray(items)) return [];\r\n  return items.map((item) => normalizeRef(db, item));\r\n}\r\n","/**\r\n * Power Calculation Utilities\r\n * ============================\r\n * Ported from public/js/calculators/power-calc.js\r\n * Provides cost calculation and display helpers for powers.\r\n */\r\n\r\nimport type { PowerPart } from '@/hooks/use-rtdb';\r\nimport { PART_IDS, findByIdOrName } from '@/lib/id-constants';\r\n\r\n// Re-export for backwards compatibility\r\nexport { PART_IDS, findByIdOrName };\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface PowerPartPayload {\r\n  id?: number;\r\n  name?: string;\r\n  part?: PowerPart;\r\n  op_1_lvl?: number;\r\n  op_2_lvl?: number;\r\n  op_3_lvl?: number;\r\n  opt1Level?: number; // Legacy format\r\n  opt2Level?: number;\r\n  opt3Level?: number;\r\n  applyDuration?: boolean;\r\n}\r\n\r\nexport interface PowerCostResult {\r\n  totalEnergy: number;\r\n  totalTP: number;\r\n  tpSources: string[];\r\n  energyRaw: number;\r\n}\r\n\r\nexport interface PowerDisplayData {\r\n  name: string;\r\n  description: string;\r\n  actionType: string;\r\n  range: string;\r\n  area: string;\r\n  duration: string;\r\n  energy: number;\r\n  tp: number;\r\n  tpSources: string[];\r\n  partChips: PartChipData[];\r\n}\r\n\r\nexport interface PartChipData {\r\n  text: string;\r\n  description: string;\r\n  finalTP: number;\r\n  hasTP: boolean;\r\n}\r\n\r\n/**\r\n * Get option level from payload, supporting both formats\r\n */\r\nfunction getOptionLevel(pl: PowerPartPayload, option: 1 | 2 | 3): number {\r\n  const isUiShape = pl.part !== undefined;\r\n  if (option === 1) return isUiShape ? (pl.op_1_lvl ?? pl.opt1Level ?? 0) : (pl.op_1_lvl ?? 0);\r\n  if (option === 2) return isUiShape ? (pl.op_2_lvl ?? pl.opt2Level ?? 0) : (pl.op_2_lvl ?? 0);\r\n  return isUiShape ? (pl.op_3_lvl ?? pl.opt3Level ?? 0) : (pl.op_3_lvl ?? 0);\r\n}\r\n\r\n// =============================================================================\r\n// Core Cost Calculator\r\n// =============================================================================\r\n\r\n/**\r\n * Calculate total energy, TP and list TP sources for a power.\r\n * Uses the unified equation:\r\n * (flat_normal * perc_all) + ((dur_all + 1) * flat_duration * perc_dur) - (flat_duration * perc_dur)\r\n */\r\nexport function calculatePowerCosts(\r\n  partsPayload: PowerPartPayload[] = [],\r\n  partsDb: PowerPart[] = []\r\n): PowerCostResult {\r\n  let flat_normal = 0;\r\n  let flat_duration = 0;\r\n  let perc_all = 1;\r\n  let perc_dur = 1;\r\n  let dur_all = 1;\r\n  let hasDurationParts = false;\r\n  let totalTP = 0;\r\n  const tpSources: string[] = [];\r\n\r\n  partsPayload.forEach((pl) => {\r\n    // Normalize to support both saved-format and UI-format\r\n    const isUiShape = pl.part !== undefined;\r\n\r\n    // Get part definition - prefer ID lookup, fallback to name\r\n    let def: PowerPart | undefined;\r\n    if (isUiShape) {\r\n      def = pl.part;\r\n    } else {\r\n      def = findByIdOrName(partsDb, pl);\r\n    }\r\n    if (!def) return;\r\n\r\n    const l1 = getOptionLevel(pl, 1);\r\n    const l2 = getOptionLevel(pl, 2);\r\n    const l3 = getOptionLevel(pl, 3);\r\n    const applyToDuration = pl.applyDuration || false;\r\n\r\n    // Energy contribution (effective energy)\r\n    const energyContribution =\r\n      (def.base_en || 0) +\r\n      (def.op_1_en || 0) * l1 +\r\n      (def.op_2_en || 0) * l2 +\r\n      (def.op_3_en || 0) * l3;\r\n\r\n    // Categorize based on part flags\r\n    const isDuration = def.duration;\r\n    const isPercentage = def.percentage;\r\n\r\n    if (isDuration) {\r\n      dur_all *= energyContribution;\r\n      hasDurationParts = true;\r\n    } else if (isPercentage) {\r\n      perc_all *= energyContribution;\r\n      if (applyToDuration) perc_dur *= energyContribution;\r\n    } else {\r\n      flat_normal += energyContribution;\r\n      if (applyToDuration) flat_duration += energyContribution;\r\n    }\r\n\r\n    // TP calculation (floor entire sum)\r\n    const rawTP =\r\n      (def.base_tp || 0) +\r\n      (def.op_1_tp || 0) * l1 +\r\n      (def.op_2_tp || 0) * l2 +\r\n      (def.op_3_tp || 0) * l3;\r\n\r\n    const partTP = Math.floor(rawTP);\r\n    if (partTP > 0) {\r\n      let src = `${partTP} TP: ${def.name}`;\r\n      if (l1 > 0) src += ` (Opt1 ${l1})`;\r\n      if (l2 > 0) src += ` (Opt2 ${l2})`;\r\n      if (l3 > 0) src += ` (Opt3 ${l3})`;\r\n      tpSources.push(src);\r\n    }\r\n    totalTP += partTP;\r\n  });\r\n\r\n  // If no duration parts exist, dur_all should be 0 (not 1)\r\n  if (!hasDurationParts) dur_all = 0;\r\n\r\n  // Unified power energy equation\r\n  const totalEnergyRaw =\r\n    flat_normal * perc_all +\r\n    (dur_all + 1) * flat_duration * perc_dur -\r\n    flat_duration * perc_dur;\r\n  const totalEnergy = Math.ceil(totalEnergyRaw);\r\n\r\n  return { totalEnergy, totalTP, tpSources, energyRaw: totalEnergyRaw };\r\n}\r\n\r\n// =============================================================================\r\n// Action Type\r\n// =============================================================================\r\n\r\n/**\r\n * Compute action type from parts payload\r\n */\r\nexport function computeActionType(\r\n  partsPayload: PowerPartPayload[] = [],\r\n  partsDb: PowerPart[] = []\r\n): string {\r\n  let actionType = 'Basic';\r\n  let isReaction = false;\r\n\r\n  partsPayload.forEach((p) => {\r\n    // Get part ID\r\n    let partId: number | undefined;\r\n    if (p.part?.id !== undefined) {\r\n      partId = Number(p.part.id);\r\n    } else if (p.id !== undefined) {\r\n      partId = p.id;\r\n    } else if (p.part?.name || p.name) {\r\n      const name = p.part?.name || p.name;\r\n      const def = findByIdOrName(partsDb, { name: name! });\r\n      partId = def ? Number(def.id) : undefined;\r\n    }\r\n\r\n    const l1 = getOptionLevel(p, 1);\r\n\r\n    if (partId === PART_IDS.POWER_REACTION) isReaction = true;\r\n    else if (partId === PART_IDS.POWER_QUICK_OR_FREE_ACTION) {\r\n      if (l1 === 0) actionType = 'Quick';\r\n      else if (l1 === 1) actionType = 'Free';\r\n    } else if (partId === PART_IDS.POWER_LONG_ACTION) {\r\n      if (l1 === 0) actionType = 'Long (3)';\r\n      else if (l1 === 1) actionType = 'Long (4)';\r\n    }\r\n  });\r\n\r\n  return isReaction ? `${actionType} Reaction` : `${actionType} Action`;\r\n}\r\n\r\n/**\r\n * Helper when UI stores selector value\r\n */\r\nexport function computeActionTypeFromSelection(\r\n  selection: string,\r\n  reactionFlag: boolean\r\n): string {\r\n  let base = 'Basic';\r\n  if (selection === 'quick') base = 'Quick';\r\n  else if (selection === 'free') base = 'Free';\r\n  else if (selection === 'long3') base = 'Long (3)';\r\n  else if (selection === 'long4') base = 'Long (4)';\r\n  return reactionFlag ? `${base} Reaction` : `${base} Action`;\r\n}\r\n\r\n// =============================================================================\r\n// Range / Area / Duration Derivation\r\n// =============================================================================\r\n\r\n/**\r\n * Derive range string from parts\r\n */\r\nexport function deriveRange(\r\n  partsPayload: PowerPartPayload[] = [],\r\n  partsDb: PowerPart[] = []\r\n): string {\r\n  const pr = partsPayload.find((p) => {\r\n    const partId = p.part?.id ?? p.id;\r\n    if (Number(partId) === PART_IDS.POWER_RANGE) return true;\r\n    const name = p.part?.name || p.name;\r\n    return name === 'Power Range';\r\n  });\r\n  if (!pr) return '1 space';\r\n  const lvl = getOptionLevel(pr, 1);\r\n  const spaces = 3 + 3 * lvl;\r\n  return `${spaces} ${spaces > 1 ? 'spaces' : 'space'}`;\r\n}\r\n\r\n/**\r\n * Derive area string from parts\r\n */\r\nexport function deriveArea(\r\n  partsPayload: PowerPartPayload[] = [],\r\n  _partsDb: PowerPart[] = []\r\n): string {\r\n  const areaPartIds = [\r\n    PART_IDS.SPHERE_OF_EFFECT,\r\n    PART_IDS.CYLINDER_OF_EFFECT,\r\n    PART_IDS.CONE_OF_EFFECT,\r\n    PART_IDS.LINE_OF_EFFECT,\r\n    PART_IDS.TRAIL_OF_EFFECT,\r\n  ];\r\n  const areaNames = ['Sphere', 'Cylinder', 'Cone', 'Line', 'Trail'];\r\n\r\n  for (let i = 0; i < areaPartIds.length; i++) {\r\n    const found = partsPayload.find((p) => {\r\n      const partId = p.part?.id ?? p.id;\r\n      if (Number(partId) === areaPartIds[i]) return true;\r\n      const name = p.part?.name || p.name;\r\n      return name === `${areaNames[i]} of Effect`;\r\n    });\r\n    if (found) return areaNames[i];\r\n  }\r\n  return '1 target';\r\n}\r\n\r\n/**\r\n * Derive duration string from parts\r\n */\r\nexport function deriveDuration(\r\n  partsPayload: PowerPartPayload[] = [],\r\n  _partsDb: PowerPart[] = []\r\n): string {\r\n  const findPartById = (partId: number, fallbackName: string) =>\r\n    partsPayload.find((p) => {\r\n      const id = p.part?.id ?? p.id;\r\n      if (Number(id) === partId) return true;\r\n      const name = p.part?.name || p.name;\r\n      return name === fallbackName;\r\n    });\r\n  const getLvl = (p: PowerPartPayload | undefined) =>\r\n    p ? getOptionLevel(p, 1) : 0;\r\n\r\n  const permanentPart = findPartById(PART_IDS.DURATION_PERMANENT, 'Duration (Permanent)');\r\n  if (permanentPart) return 'Permanent';\r\n\r\n  const roundPart = findPartById(PART_IDS.DURATION_ROUND, 'Duration (Round)');\r\n  if (roundPart) {\r\n    const lvl = getLvl(roundPart);\r\n    const rounds = 2 + lvl;\r\n    return `${rounds} ${rounds > 1 ? 'rounds' : 'round'}`;\r\n  }\r\n\r\n  const minutePart = findPartById(PART_IDS.DURATION_MINUTE, 'Duration (Minute)');\r\n  if (minutePart) {\r\n    const lvl = getLvl(minutePart);\r\n    const minutes = [1, 10, 30][lvl] || 1;\r\n    return `${minutes} minute${minutes > 1 ? 's' : ''}`;\r\n  }\r\n\r\n  const hourPart = findPartById(PART_IDS.DURATION_HOUR, 'Duration (Hour)');\r\n  if (hourPart) {\r\n    const lvl = getLvl(hourPart);\r\n    const hours = [1, 6, 12][lvl] || 1;\r\n    return `${hours} hour${hours > 1 ? 's' : ''}`;\r\n  }\r\n\r\n  const dayPart = findPartById(PART_IDS.DURATION_DAYS, 'Duration (Days)');\r\n  if (dayPart) {\r\n    const lvl = getLvl(dayPart);\r\n    const days = [1, 10, 20, 30][lvl] || 1;\r\n    return `${days} day${days > 1 ? 's' : ''}`;\r\n  }\r\n\r\n  return '1 round';\r\n}\r\n\r\n// =============================================================================\r\n// Chip Formatting\r\n// =============================================================================\r\n\r\n/**\r\n * Format a single power part as a chip\r\n */\r\nexport function formatPowerPartChip(\r\n  def: PowerPart,\r\n  pl: PowerPartPayload\r\n): PartChipData {\r\n  const l1 = pl.op_1_lvl || 0;\r\n  const l2 = pl.op_2_lvl || 0;\r\n  const l3 = pl.op_3_lvl || 0;\r\n\r\n  const rawTP =\r\n    (def.base_tp || 0) +\r\n    (def.op_1_tp || 0) * l1 +\r\n    (def.op_2_tp || 0) * l2 +\r\n    (def.op_3_tp || 0) * l3;\r\n\r\n  const finalTP = Math.floor(rawTP);\r\n  let text = def.name;\r\n  if (l1 > 0) text += ` (Opt1 ${l1})`;\r\n  if (l2 > 0) text += ` (Opt2 ${l2})`;\r\n  if (l3 > 0) text += ` (Opt3 ${l3})`;\r\n  if (finalTP > 0) text += ` | TP: ${finalTP}`;\r\n\r\n  return {\r\n    text,\r\n    description: def.description || '',\r\n    finalTP,\r\n    hasTP: finalTP > 0,\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// High-level Display Builder\r\n// =============================================================================\r\n\r\nexport interface PowerDocument {\r\n  name?: string;\r\n  description?: string;\r\n  parts?: Array<{\r\n    id?: number;\r\n    name?: string;\r\n    op_1_lvl?: number;\r\n    op_2_lvl?: number;\r\n    op_3_lvl?: number;\r\n    applyDuration?: boolean;\r\n  }>;\r\n  damage?: Array<{\r\n    amount?: number | string;\r\n    size?: number | string;\r\n    type?: string;\r\n    applyDuration?: boolean;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Build complete display data from a saved power document\r\n */\r\nexport function derivePowerDisplay(\r\n  powerDoc: PowerDocument,\r\n  partsDb: PowerPart[]\r\n): PowerDisplayData {\r\n  const partsPayload: PowerPartPayload[] = Array.isArray(powerDoc.parts)\r\n    ? powerDoc.parts.map((p) => ({\r\n        id: p.id,\r\n        name: p.name,\r\n        op_1_lvl: p.op_1_lvl || 0,\r\n        op_2_lvl: p.op_2_lvl || 0,\r\n        op_3_lvl: p.op_3_lvl || 0,\r\n        applyDuration: p.applyDuration || false,\r\n      }))\r\n    : [];\r\n\r\n  const calc = calculatePowerCosts(partsPayload, partsDb);\r\n  const actionType = computeActionType(partsPayload, partsDb);\r\n  const rangeStr = deriveRange(partsPayload, partsDb);\r\n  const areaStr = deriveArea(partsPayload, partsDb);\r\n  const durationStr = deriveDuration(partsPayload, partsDb);\r\n\r\n  // Build part chips\r\n  const partChips: PartChipData[] = partsPayload\r\n    .map((pl) => {\r\n      const def = findByIdOrName(partsDb, pl);\r\n      if (!def) return null;\r\n      return formatPowerPartChip(def, pl);\r\n    })\r\n    .filter((chip): chip is PartChipData => chip !== null);\r\n\r\n  return {\r\n    name: powerDoc.name || '',\r\n    description: powerDoc.description || '',\r\n    actionType,\r\n    range: rangeStr,\r\n    area: areaStr,\r\n    duration: durationStr,\r\n    energy: calc.totalEnergy,\r\n    tp: calc.totalTP,\r\n    tpSources: calc.tpSources,\r\n    partChips,\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// Damage Formatting\r\n// =============================================================================\r\n\r\n/**\r\n * Format power damage as [amount]d[size] [type]\r\n */\r\nexport function formatPowerDamage(\r\n  damageArr?: Array<{ amount?: number | string; size?: number | string; type?: string }>\r\n): string {\r\n  if (!Array.isArray(damageArr)) return '';\r\n  const dmg = damageArr.find(\r\n    (d) => d && d.amount && d.size && d.type && d.type !== 'none'\r\n  );\r\n  if (dmg) return `${dmg.amount}d${dmg.size} ${dmg.type}`;\r\n  return '';\r\n}\r\n","/**\r\n * Technique Calculation Utilities\r\n * ================================\r\n * Ported from public/js/calculators/technique-calc.js\r\n * Provides cost calculation and display helpers for techniques.\r\n */\r\n\r\nimport { PART_IDS, findByIdOrName } from '@/lib/id-constants';\r\nimport type { TechniquePart } from '@/hooks/use-rtdb';\r\n\r\n// Re-export for convenience\r\nexport type { TechniquePart };\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface TechniquePartPayload {\r\n  id?: number;\r\n  name?: string;\r\n  part?: TechniquePart;\r\n  op_1_lvl?: number;\r\n  op_2_lvl?: number;\r\n  op_3_lvl?: number;\r\n  applyDuration?: boolean;\r\n}\r\n\r\nexport interface TechniqueCostResult {\r\n  totalEnergy: number;\r\n  totalTP: number;\r\n  tpSources: string[];\r\n  energyRaw: number;\r\n}\r\n\r\nexport interface TechniqueDisplayData {\r\n  name: string;\r\n  description: string;\r\n  weaponName: string;\r\n  actionType: string;\r\n  damageStr: string;\r\n  energy: number;\r\n  tp: number;\r\n  tpSources: string[];\r\n  partChips: TechniqueChipData[];\r\n}\r\n\r\nexport interface TechniqueChipData {\r\n  text: string;\r\n  description: string;\r\n  finalTP: number;\r\n  hasTP: boolean;\r\n}\r\n\r\nexport interface TechniqueDocument {\r\n  name?: string;\r\n  description?: string;\r\n  parts?: TechniquePartPayload[];\r\n  damage?: { amount?: number | string; size?: number | string; type?: string };\r\n  weapon?: { id?: number; name?: string };\r\n}\r\n\r\nexport interface MechanicContext {\r\n  actionTypeSelection?: string;\r\n  reaction?: boolean;\r\n  weaponTP?: number;\r\n  diceAmt?: number;\r\n  dieSize?: number;\r\n  partsDb?: TechniquePart[];\r\n}\r\n\r\n// =============================================================================\r\n// Damage Helpers\r\n// =============================================================================\r\n\r\n/**\r\n * Compute the number of \"splits\" if using dice smaller than d12.\r\n */\r\nexport function computeSplits(diceAmt: number, dieSize: number): number {\r\n  const valid = [4, 6, 8, 10, 12];\r\n  if (!valid.includes(dieSize) || diceAmt <= 1) return 0;\r\n  const total = diceAmt * dieSize;\r\n  const minDiceUsingD12 = Math.ceil(total / 12);\r\n  return Math.max(0, diceAmt - minDiceUsingD12);\r\n}\r\n\r\n/**\r\n * Compute the option level for Additional Damage based on dice.\r\n */\r\nexport function computeAdditionalDamageLevel(diceAmt: number, dieSize: number): number {\r\n  const total = diceAmt * dieSize;\r\n  if (total <= 0) return 0;\r\n  return Math.max(0, Math.floor((total - 4) / 2));\r\n}\r\n\r\n/**\r\n * Format damage object as a string like \"+2d6\".\r\n */\r\nexport function formatTechniqueDamage(\r\n  dmgObj?: { amount?: number | string; size?: number | string } | null\r\n): string {\r\n  if (!dmgObj || !dmgObj.amount || !dmgObj.size) return '';\r\n  if (dmgObj.amount === '0' || dmgObj.size === '0') return '';\r\n  return `+${dmgObj.amount}d${dmgObj.size}`;\r\n}\r\n\r\n// =============================================================================\r\n// Action Type\r\n// =============================================================================\r\n\r\n/**\r\n * Compute action type from parts payload.\r\n */\r\nexport function computeActionType(\r\n  partsPayload: TechniquePartPayload[] = [],\r\n  partsDb: TechniquePart[] = []\r\n): string {\r\n  let actionType = 'Basic';\r\n  let isReaction = false;\r\n\r\n  partsPayload.forEach((p) => {\r\n    // Get part ID - prefer id, fallback to name lookup\r\n    let partId = p.id;\r\n    if (partId === undefined && p.name) {\r\n      const def = findByIdOrName(partsDb, { name: p.name });\r\n      partId = def?.id !== undefined ? Number(def.id) : undefined;\r\n    }\r\n\r\n    const l1 = p.op_1_lvl || 0;\r\n\r\n    if (partId === PART_IDS.REACTION) {\r\n      isReaction = true;\r\n    } else if (partId === PART_IDS.QUICK_OR_FREE_ACTION) {\r\n      if (l1 === 0) actionType = 'Quick';\r\n      else if (l1 === 1) actionType = 'Free';\r\n    } else if (partId === PART_IDS.LONG_ACTION) {\r\n      if (l1 === 0) actionType = 'Long (3)';\r\n      else if (l1 === 1) actionType = 'Long (4)';\r\n    } else {\r\n      // Legacy name-based fallback\r\n      if (p.name === 'Reaction') isReaction = true;\r\n      else if (p.name === 'Quick or Free Action') {\r\n        if (l1 === 0) actionType = 'Quick';\r\n        else if (l1 === 1) actionType = 'Free';\r\n      } else if (p.name === 'Long Action') {\r\n        if (l1 === 0) actionType = 'Long (3)';\r\n        else if (l1 === 1) actionType = 'Long (4)';\r\n      }\r\n    }\r\n  });\r\n\r\n  return isReaction ? `${actionType} Reaction` : `${actionType} Action`;\r\n}\r\n\r\n/**\r\n * Helper when UI stores a selector value like: quick|free|long3|long4|basic\r\n */\r\nexport function computeActionTypeFromSelection(selection: string, reactionFlag: boolean): string {\r\n  let base = 'Basic';\r\n  if (selection === 'quick') base = 'Quick';\r\n  else if (selection === 'free') base = 'Free';\r\n  else if (selection === 'long3') base = 'Long (3)';\r\n  else if (selection === 'long4') base = 'Long (4)';\r\n  return reactionFlag ? `${base} Reaction` : `${base} Action`;\r\n}\r\n\r\n// =============================================================================\r\n// Mechanic Part Assembly\r\n// =============================================================================\r\n\r\n/**\r\n * Build mechanic part payloads based on current UI selections.\r\n * Used to auto-generate action/damage parts based on selections.\r\n */\r\nexport function buildMechanicPartPayload(\r\n  ctx: MechanicContext\r\n): Array<{ id: number; name: string; op_1_lvl: number; op_2_lvl: number; op_3_lvl: number }> {\r\n  const {\r\n    actionTypeSelection = 'basic',\r\n    reaction = false,\r\n    weaponTP = 0,\r\n    diceAmt = 0,\r\n    dieSize = 0,\r\n    partsDb = [],\r\n  } = ctx || {};\r\n\r\n  const payload: Array<{ id: number; name: string; op_1_lvl: number; op_2_lvl: number; op_3_lvl: number }> = [];\r\n\r\n  function pushIf(partId: number, partName: string, op1 = 0): void {\r\n    // Try by ID first, then by name for backwards compatibility\r\n    let def = findByIdOrName(partsDb, { id: partId });\r\n    if (!def) def = findByIdOrName(partsDb, { name: partName });\r\n    // Only include mechanic parts\r\n    if (def && def.mechanic) {\r\n      payload.push({\r\n        id: Number(def.id),\r\n        name: def.name || partName,\r\n        op_1_lvl: op1,\r\n        op_2_lvl: 0,\r\n        op_3_lvl: 0,\r\n      });\r\n    }\r\n  }\r\n\r\n  // Action / Reaction\r\n  if (reaction) pushIf(PART_IDS.REACTION, 'Reaction', 0);\r\n  if (actionTypeSelection === 'quick') pushIf(PART_IDS.QUICK_OR_FREE_ACTION, 'Quick or Free Action', 0);\r\n  else if (actionTypeSelection === 'free') pushIf(PART_IDS.QUICK_OR_FREE_ACTION, 'Quick or Free Action', 1);\r\n  else if (actionTypeSelection === 'long3') pushIf(PART_IDS.LONG_ACTION, 'Long Action', 0);\r\n  else if (actionTypeSelection === 'long4') pushIf(PART_IDS.LONG_ACTION, 'Long Action', 1);\r\n\r\n  // Additional Damage\r\n  if (diceAmt > 0 && dieSize >= 4) {\r\n    const level = computeAdditionalDamageLevel(diceAmt, dieSize);\r\n    pushIf(PART_IDS.ADDITIONAL_DAMAGE, 'Additional Damage', level);\r\n    // Split Damage Dice\r\n    const splits = computeSplits(diceAmt, dieSize);\r\n    if (splits > 0) pushIf(PART_IDS.SPLIT_DAMAGE_DICE, 'Split Damage Dice', splits - 1);\r\n  }\r\n\r\n  // Weapon Attack scaling\r\n  if (weaponTP >= 1) {\r\n    pushIf(PART_IDS.ADD_WEAPON_ATTACK, 'Add Weapon Attack', weaponTP - 1);\r\n  }\r\n\r\n  return payload;\r\n}\r\n\r\n// =============================================================================\r\n// Core Cost Calculator\r\n// =============================================================================\r\n\r\n/**\r\n * Calculate total energy, TP and list TP sources.\r\n */\r\nexport function calculateTechniqueCosts(\r\n  partsPayload: TechniquePartPayload[] = [],\r\n  partsDb: TechniquePart[] = []\r\n): TechniqueCostResult {\r\n  let sumNonPercentage = 0;\r\n  let productPercentage = 1;\r\n  let totalTP = 0;\r\n  const tpSources: string[] = [];\r\n\r\n  partsPayload.forEach((pl) => {\r\n    // Find part by ID or name for backwards compatibility\r\n    const def = findByIdOrName(partsDb, {\r\n      id: pl.id ?? pl.part?.id,\r\n      name: pl.name ?? pl.part?.name,\r\n    });\r\n    if (!def) return;\r\n\r\n    const l1 = pl.op_1_lvl || 0;\r\n    const l2 = pl.op_2_lvl || 0;\r\n    const l3 = pl.op_3_lvl || 0;\r\n\r\n    // Energy\r\n    const energyContribution =\r\n      (def.base_en || 0) +\r\n      (def.op_1_en || 0) * l1 +\r\n      (def.op_2_en || 0) * l2 +\r\n      (def.op_3_en || 0) * l3;\r\n\r\n    if (def.percentage) {\r\n      productPercentage *= energyContribution;\r\n    } else {\r\n      sumNonPercentage += energyContribution;\r\n    }\r\n\r\n    // TP (special floor for Additional Damage option1)\r\n    let opt1TPRaw = (def.op_1_tp || 0) * l1;\r\n    const defId = typeof def.id === 'string' ? parseInt(def.id, 10) : def.id;\r\n    if (defId === PART_IDS.ADDITIONAL_DAMAGE || def.name === 'Additional Damage') {\r\n      opt1TPRaw = Math.floor(opt1TPRaw);\r\n    }\r\n\r\n    const rawTP =\r\n      (def.base_tp || 0) + opt1TPRaw + (def.op_2_tp || 0) * l2 + (def.op_3_tp || 0) * l3;\r\n\r\n    const partTP = Math.floor(rawTP);\r\n    if (partTP > 0) {\r\n      let src = `${partTP} TP: ${def.name}`;\r\n      if (l1 > 0) src += ` (Opt1 ${l1})`;\r\n      if (l2 > 0) src += ` (Opt2 ${l2})`;\r\n      if (l3 > 0) src += ` (Opt3 ${l3})`;\r\n      tpSources.push(src);\r\n    }\r\n    totalTP += partTP;\r\n  });\r\n\r\n  const energyRaw = sumNonPercentage * productPercentage;\r\n  const totalEnergy = Math.ceil(energyRaw);\r\n  return { totalEnergy, totalTP, tpSources, energyRaw };\r\n}\r\n\r\n// =============================================================================\r\n// Chip Formatting\r\n// =============================================================================\r\n\r\n/**\r\n * Format a part for display as a chip/badge.\r\n */\r\nexport function formatTechniquePartChip(\r\n  def: TechniquePart,\r\n  pl: TechniquePartPayload\r\n): TechniqueChipData {\r\n  const l1 = pl.op_1_lvl || 0;\r\n  const l2 = pl.op_2_lvl || 0;\r\n  const l3 = pl.op_3_lvl || 0;\r\n\r\n  let opt1TPRaw = (def.op_1_tp || 0) * l1;\r\n  const defId = typeof def.id === 'string' ? parseInt(def.id, 10) : def.id;\r\n  if (defId === PART_IDS.ADDITIONAL_DAMAGE || def.name === 'Additional Damage') {\r\n    opt1TPRaw = Math.floor(opt1TPRaw);\r\n  }\r\n\r\n  const rawTP =\r\n    (def.base_tp || 0) + opt1TPRaw + (def.op_2_tp || 0) * l2 + (def.op_3_tp || 0) * l3;\r\n\r\n  const finalTP = Math.floor(rawTP);\r\n  let text = def.name || '';\r\n  if (l1 > 0) text += ` (Opt1 ${l1})`;\r\n  if (l2 > 0) text += ` (Opt2 ${l2})`;\r\n  if (l3 > 0) text += ` (Opt3 ${l3})`;\r\n  if (finalTP > 0) text += ` | TP: ${finalTP}`;\r\n\r\n  return {\r\n    text,\r\n    description: def.description || '',\r\n    finalTP,\r\n    hasTP: finalTP > 0,\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// High-level Display Builder\r\n// =============================================================================\r\n\r\n/**\r\n * Build display data for a technique document.\r\n */\r\nexport function deriveTechniqueDisplay(\r\n  techniqueDoc: TechniqueDocument,\r\n  partsDb: TechniquePart[]\r\n): TechniqueDisplayData {\r\n  const partsPayload: TechniquePartPayload[] = Array.isArray(techniqueDoc.parts)\r\n    ? techniqueDoc.parts.map((p) => ({\r\n        id: p.id,\r\n        name: p.name,\r\n        op_1_lvl: p.op_1_lvl || 0,\r\n        op_2_lvl: p.op_2_lvl || 0,\r\n        op_3_lvl: p.op_3_lvl || 0,\r\n      }))\r\n    : [];\r\n\r\n  const calc = calculateTechniqueCosts(partsPayload, partsDb);\r\n  const actionType = computeActionType(partsPayload, partsDb);\r\n  const damageStr = formatTechniqueDamage(techniqueDoc.damage);\r\n  const weaponName =\r\n    techniqueDoc.weapon && (techniqueDoc.weapon.name || techniqueDoc.weapon.id)\r\n      ? techniqueDoc.weapon.name || `Weapon #${techniqueDoc.weapon.id}`\r\n      : 'Unarmed';\r\n\r\n  const partChips: TechniqueChipData[] = partsPayload\r\n    .map((pl) => {\r\n      const def = findByIdOrName(partsDb, pl);\r\n      if (!def) return null;\r\n      return formatTechniquePartChip(def, pl);\r\n    })\r\n    .filter((chip): chip is TechniqueChipData => chip !== null);\r\n\r\n  return {\r\n    name: techniqueDoc.name || '',\r\n    description: techniqueDoc.description || '',\r\n    weaponName,\r\n    actionType,\r\n    damageStr,\r\n    energy: calc.totalEnergy,\r\n    tp: calc.totalTP,\r\n    tpSources: calc.tpSources,\r\n    partChips,\r\n  };\r\n}\r\n","/**\r\n * Item Calculation Utilities\r\n * ===========================\r\n * Ported from public/js/calculators/item-calc.js\r\n * Provides cost calculation and display helpers for items.\r\n */\r\n\r\nimport { PROPERTY_IDS, GENERAL_PROPERTY_IDS, GENERAL_PROPERTY_NAMES, findByIdOrName } from '@/lib/id-constants';\r\nimport type { ItemProperty } from '@/hooks/use-rtdb';\r\n\r\n// Re-export for convenience\r\nexport { PROPERTY_IDS, GENERAL_PROPERTY_IDS, GENERAL_PROPERTY_NAMES };\r\nexport type { ItemProperty };\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface ItemPropertyPayload {\r\n  id?: number;\r\n  name?: string;\r\n  op_1_lvl?: number;\r\n  property?: ItemProperty;\r\n}\r\n\r\nexport interface ItemCostResult {\r\n  totalIP: number;\r\n  totalTP: number;\r\n  totalCurrency: number;\r\n}\r\n\r\nexport interface RarityResult {\r\n  currencyCost: number;\r\n  rarity: string;\r\n}\r\n\r\nexport interface ProficiencyInfo {\r\n  id: number | string;\r\n  name: string;\r\n  level: number;\r\n  baseTP: number;\r\n  optionTP: number;\r\n  totalTP: number;\r\n  description: string;\r\n}\r\n\r\nexport interface ItemDamage {\r\n  amount: number | string;\r\n  size: number | string;\r\n  type: string;\r\n}\r\n\r\nexport interface ItemDocument {\r\n  name?: string;\r\n  description?: string;\r\n  armamentType?: 'Weapon' | 'Armor' | 'Shield' | 'Accessory';\r\n  properties?: ItemPropertyPayload[];\r\n  damage?: ItemDamage[];\r\n}\r\n\r\nexport interface ItemDisplayData {\r\n  name: string;\r\n  armamentType: string;\r\n  description: string;\r\n  rarity: string;\r\n  currencyCost: number;\r\n  goldCost: number; // Legacy alias\r\n  totalIP: number;\r\n  totalTP: number;\r\n  totalCurrency: number;\r\n  range: string;\r\n  damage: string;\r\n  damageReduction: number;\r\n  proficiencies: ProficiencyInfo[];\r\n}\r\n\r\n// =============================================================================\r\n// Constants\r\n// =============================================================================\r\n\r\nconst RARITY_BRACKETS = [\r\n  { name: 'Common', low: 25, ipLow: 0, ipHigh: 4 },\r\n  { name: 'Uncommon', low: 100, ipLow: 4.01, ipHigh: 6 },\r\n  { name: 'Rare', low: 500, ipLow: 6.01, ipHigh: 8 },\r\n  { name: 'Epic', low: 2500, ipLow: 8.01, ipHigh: 11 },\r\n  { name: 'Legendary', low: 10000, ipLow: 11.01, ipHigh: 14 },\r\n  { name: 'Mythic', low: 50000, ipLow: 14.01, ipHigh: 16 },\r\n  { name: 'Ascended', low: 100000, ipLow: 16.01, ipHigh: Infinity },\r\n] as const;\r\n\r\n// =============================================================================\r\n// Helpers\r\n// =============================================================================\r\n\r\n/**\r\n * Check if a property is a general/built-in property.\r\n */\r\nexport function isGeneralProperty(prop: ItemPropertyPayload | ItemProperty): boolean {\r\n  if (!prop) return false;\r\n  if ('id' in prop && prop.id !== undefined && GENERAL_PROPERTY_IDS.has(prop.id as number)) {\r\n    return true;\r\n  }\r\n  if ('name' in prop && prop.name && GENERAL_PROPERTY_NAMES.has(prop.name)) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Compute number of damage dice splits needed.\r\n */\r\nexport function computeSplits(diceAmt: number, dieSize: number): number {\r\n  const valid = [4, 6, 8, 10, 12];\r\n  if (!valid.includes(dieSize) || diceAmt <= 1) return 0;\r\n  const total = diceAmt * dieSize;\r\n  const minDiceUsingD12 = Math.ceil(total / 12);\r\n  return Math.max(0, diceAmt - minDiceUsingD12);\r\n}\r\n\r\n// =============================================================================\r\n// Core Calculations\r\n// =============================================================================\r\n\r\n/**\r\n * Calculate currency cost and rarity from IP and currency totals.\r\n */\r\nexport function calculateCurrencyCostAndRarity(\r\n  totalCurrency: number,\r\n  totalIP: number\r\n): RarityResult {\r\n  const ip = Math.max(0, totalIP);\r\n  const c = Math.max(0, totalCurrency);\r\n  let rarity = 'Common';\r\n  let currencyCost = 0;\r\n\r\n  for (const br of RARITY_BRACKETS) {\r\n    if (ip >= br.ipLow && ip <= br.ipHigh) {\r\n      rarity = br.name;\r\n      currencyCost = br.low * (1 + 0.125 * c);\r\n      break;\r\n    }\r\n  }\r\n\r\n  const bracket = RARITY_BRACKETS.find((b) => b.name === rarity);\r\n  if (bracket) currencyCost = Math.max(currencyCost, bracket.low);\r\n\r\n  return { currencyCost: Math.floor(currencyCost), rarity };\r\n}\r\n\r\n// Legacy alias\r\nexport const calculateGoldCostAndRarity = calculateCurrencyCostAndRarity;\r\n\r\n/**\r\n * Calculate total IP, TP, and Currency from properties.\r\n */\r\nexport function calculateItemCosts(\r\n  properties: ItemPropertyPayload[],\r\n  propertiesData: ItemProperty[]\r\n): ItemCostResult {\r\n  let totalIP = 0;\r\n  let totalTP = 0;\r\n  let totalCurrency = 0;\r\n\r\n  (properties || []).forEach((ref) => {\r\n    const data = findByIdOrName(propertiesData, ref);\r\n    if (!data) return;\r\n\r\n    const lvl = ref.op_1_lvl || 0;\r\n\r\n    // Access properties with optional chaining for safety\r\n    const baseIP = (data as unknown as { base_ip?: number }).base_ip || 0;\r\n    const op1IP = (data as unknown as { op_1_ip?: number }).op_1_ip || 0;\r\n    const baseTP = (data as unknown as { base_tp?: number }).base_tp || 0;\r\n    const op1TP = (data as unknown as { op_1_tp?: number }).op_1_tp || 0;\r\n    const baseC = (data as unknown as { base_c?: number }).base_c || 0;\r\n    const op1C = (data as unknown as { op_1_c?: number }).op_1_c || 0;\r\n\r\n    totalIP += baseIP + op1IP * lvl;\r\n    totalTP += baseTP + op1TP * lvl;\r\n    totalCurrency += baseC + op1C * lvl;\r\n  });\r\n\r\n  return { totalIP, totalTP, totalCurrency };\r\n}\r\n\r\n/**\r\n * Format damage array as a string.\r\n */\r\nexport function formatDamage(damageArr?: ItemDamage[]): string {\r\n  if (!Array.isArray(damageArr)) return '';\r\n  return damageArr\r\n    .filter((d) => d && d.amount && d.size && d.type && d.type !== 'none')\r\n    .map((d) => `${d.amount}d${d.size} ${d.type}`)\r\n    .join(', ');\r\n}\r\n\r\n/**\r\n * Format range from properties.\r\n */\r\nexport function formatRange(properties: ItemPropertyPayload[]): string {\r\n  const prop = (properties || []).find((p) => {\r\n    if (p.id === PROPERTY_IDS.RANGE) return true;\r\n    return p.name === 'Range';\r\n  });\r\n  if (!prop) return 'Melee';\r\n  const lvl = prop.op_1_lvl || 0;\r\n  return `${8 + lvl * 8} Spaces`;\r\n}\r\n\r\n/**\r\n * Derive Damage Reduction from properties.\r\n */\r\nexport function deriveDamageReductionFromProperties(properties: ItemPropertyPayload[]): number {\r\n  const drProp = (properties || []).find((p) => {\r\n    if (p.id === PROPERTY_IDS.DAMAGE_REDUCTION) return true;\r\n    return p.name === 'Damage Reduction';\r\n  });\r\n  if (!drProp) return 0;\r\n  return 1 + (drProp.op_1_lvl || 0);\r\n}\r\n\r\n/**\r\n * Extract proficiencies (TP sources) from properties.\r\n */\r\nexport function extractProficiencies(\r\n  properties: ItemPropertyPayload[],\r\n  propertiesData: ItemProperty[]\r\n): ProficiencyInfo[] {\r\n  const profs: ProficiencyInfo[] = [];\r\n\r\n  (properties || []).forEach((ref) => {\r\n    const data = findByIdOrName(propertiesData, ref);\r\n    if (!data) return;\r\n\r\n    const lvl = ref.op_1_lvl || 0;\r\n    const baseTP = (data as unknown as { base_tp?: number }).base_tp || 0;\r\n    const op1TP = (data as unknown as { op_1_tp?: number }).op_1_tp || 0;\r\n    const optTP = lvl > 0 ? op1TP * lvl : 0;\r\n    const totalTP = baseTP + optTP;\r\n\r\n    if (totalTP > 0) {\r\n      profs.push({\r\n        id: data.id || 0,\r\n        name: data.name || '',\r\n        level: lvl,\r\n        baseTP,\r\n        optionTP: optTP,\r\n        totalTP,\r\n        description: data.description || '',\r\n      });\r\n    }\r\n  });\r\n\r\n  return profs;\r\n}\r\n\r\n/**\r\n * Build full display data from a saved item document.\r\n */\r\nexport function deriveItemDisplay(\r\n  item: ItemDocument,\r\n  propertiesData: ItemProperty[]\r\n): ItemDisplayData {\r\n  const properties = item.properties || [];\r\n  const costs = calculateItemCosts(properties, propertiesData);\r\n  const { currencyCost, rarity } = calculateCurrencyCostAndRarity(\r\n    costs.totalCurrency,\r\n    costs.totalIP\r\n  );\r\n  const damageStr = formatDamage(item.damage);\r\n  const rangeStr = formatRange(properties);\r\n  const dr = deriveDamageReductionFromProperties(properties);\r\n  const profs = extractProficiencies(properties, propertiesData);\r\n\r\n  return {\r\n    name: item.name || '',\r\n    armamentType: item.armamentType || 'Weapon',\r\n    description: item.description || '',\r\n    rarity,\r\n    currencyCost,\r\n    goldCost: currencyCost, // Legacy alias\r\n    totalIP: costs.totalIP,\r\n    totalTP: costs.totalTP,\r\n    totalCurrency: costs.totalCurrency,\r\n    range: rangeStr,\r\n    damage: damageStr,\r\n    damageReduction: dr,\r\n    proficiencies: profs,\r\n  };\r\n}\r\n\r\n/**\r\n * Format a proficiency chip for display.\r\n */\r\nexport function formatProficiencyChip(p: ProficiencyInfo): string {\r\n  let txt = p.name;\r\n  if (p.level > 0) txt += ` (Level ${p.level})`;\r\n  if (p.totalTP > 0) {\r\n    txt += ` | TP: ${p.baseTP}`;\r\n    if (p.optionTP > 0) txt += ` + ${p.optionTP}`;\r\n  }\r\n  return txt;\r\n}\r\n"],"names":[],"mappings":"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"}