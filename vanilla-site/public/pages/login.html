<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login - Realms</title>
    <link rel="stylesheet" href="/css/layouts/main.css">
    <link rel="stylesheet" href="/css/pages/login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;700;900&display=swap" rel="stylesheet">
    <script type="module">
      import { initializeFirebase, handleAuthStateChange } from '/js/core/auth.js';
      import { signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

      document.addEventListener('DOMContentLoaded', async function() {
        const { auth, db } = await initializeFirebase();
        handleAuthStateChange(auth, db);

        // Username sign-in (show modal)
        document.getElementById('username-signin').addEventListener('click', (e) => {
          e.preventDefault();
          showUsernameForm();
        });

        // Google sign-in
        document.getElementById('google-signin').addEventListener('click', async (e) => {
          e.preventDefault();
          const provider = new GoogleAuthProvider();
          try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            const email = user.email;
            const username = email.split('@')[0].substring(0, 5);
            await setDoc(doc(db, 'users', user.uid), { username });
            alert('User signed in with Google successfully');
            console.log('Signed in with Google!');
            window.location.href = '/index.html';
          } catch (error) {
            console.error('Error signing in with Google:', error);
            handleAuthError(error);
          }
        });

        // Apple sign-in (placeholder)
        document.getElementById('apple-signin').addEventListener('click', (e) => {
          e.preventDefault();
          alert('Apple Sign-In coming soon!');
        });

        // Create account
        document.getElementById('create-account').addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/register.html';
        });

        function showUsernameForm() {
          const modal = document.getElementById('username-modal');
          modal.style.display = 'block';
        }

        // Username form submission
        document.getElementById('username-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('modal-email').value;
          const password = document.getElementById('modal-password').value;
          try {
            await signInWithEmailAndPassword(auth, email, password);
            alert('User logged in successfully');
            console.log('Signed in!');
            window.location.href = '/index.html';
          } catch (error) {
            console.error('Error logging in user:', error);
            handleAuthError(error);
          }
        });

        // Close modal
        document.getElementById('close-modal').addEventListener('click', () => {
          document.getElementById('username-modal').style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
          const modal = document.getElementById('username-modal');
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });

        function handleAuthError(error) {
          if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            alert('Invalid email or password');
          } else if (error.code === 'auth/too-many-requests') {
            alert('Too many failed login attempts. Please try again later.');
          } else if (error.code === 'auth/network-request-failed') {
            alert('Network error. Please check your internet connection and try again.');
          } else if (error.code === 'auth/account-exists-with-different-credential') {
            alert('An account already exists with the same email address but different sign-in credentials. Please use a different sign-in method.');
          } else if (error.code === 'auth/popup-closed-by-user') {
            alert('The popup has been closed by the user before finalizing the operation.');
          } else if (error.code === 'auth/cancelled-popup-request') {
            alert('The popup request was cancelled. Please try again.');
          } else {
            alert('Error during authentication');
          }
        }
      });
    </script>
  </head>
  <body class="login-body">
    <div class="login-container">
      <!-- Background -->
      <div class="background-image">
        <img src="/images/LoginBackground.jpg" alt="Background" />
      </div>

      <!-- Decorative D20 Elements -->
      <div class="d20-element d20-top-right">
        <img src="/images/D20_1.png" alt="D20" />
      </div>
      <div class="d20-element d20-left-small">
        <img src="/images/D20_2.png" alt="D20" />
      </div>
      <div class="d20-element d20-bottom-left">
        <img src="/images/D20_3.png" alt="D20" />
      </div>
      <div class="d20-element d20-bottom-center">
        <img src="/images/D20_4.png" alt="D20" />
      </div>

      <!-- Brand Section -->
      <div class="brand-section">
        <div class="brand-logo">
          <img src="/images/LogoFull.png" alt="Realms Logo" />
        </div>
        <div class="brand-description">
          <p class="tagline">Forge your own path.</p>
          <p class="description">Create unique powers and bring your characters to life.</p>
        </div>
      </div>

      <!-- Sign In Buttons Section -->
      <div class="signin-buttons-section">
        <button class="signin-button signin-username" id="username-signin">
          <span class="signin-text">Sign in with Username</span>
        </button>

        <button class="signin-button signin-google signin-button-with-logo" id="google-signin">
          <div class="signin-logo">
            <img src="/images/Google.png" alt="Google Logo" />
          </div>
          <span class="signin-text">Sign in with Google</span>
        </button>

        <button class="signin-button signin-apple signin-button-with-logo" id="apple-signin">
          <div class="signin-logo">
            <img src="/images/Apple.png" alt="Apple Logo" />
          </div>
          <span class="signin-text">Sign in with Apple</span>
        </button>

        <div class="or-divider">
          <img src="https://figma-alpha-api.s3.us-west-2.amazonaws.com/images/643c383d-cdad-4f2a-8810-4b0b4b51579d" alt="or" />
        </div>

        <button class="create-account-button" id="create-account">
          Create Account
        </button>
      </div>
    </div>

    <footer id="footer"></footer>

    <!-- Username Sign-In Modal -->
    <div id="username-modal" class="modal">
      <div class="modal-content">
        <span class="close" id="close-modal">&times;</span>
        <h2>Sign In</h2>
        <form id="username-form">
          <input type="email" id="modal-email" placeholder="Email" required>
          <input type="password" id="modal-password" placeholder="Password" required>
          <button type="submit">Sign In</button>
        </form>
        <div class="modal-links">
          <a href="forgot-password.html">Forgot My Password</a>
          <a href="forgot-username.html">Forgot My Email/Username</a>
        </div>
      </div>
    </div>

    <script type="module">
      async function loadFooter() {
        const footer = document.getElementById('footer');
        if (footer) {
          footer.innerHTML = await fetch('/partials/footer.html').then(response => response.text());
        }
      }
      loadFooter();
    </script>
  </body>
</html>
