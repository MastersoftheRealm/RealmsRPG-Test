// RealmsRPG â€” Prisma schema for Supabase PostgreSQL
// Maps Firestore collections to relational tables

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public", "users", "campaigns", "codex", "encounters"]
}

// =============================================================================
// User & Profile
// =============================================================================

model UserProfile {
  id                  String    @id @default(uuid())
  email               String?
  displayName         String?   @map("display_name")
  username            String?   @unique
  photoUrl            String?   @map("photo_url")
  lastUsernameChange  DateTime? @map("last_username_change")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  characters       Character[]
  userPowers       UserPower[]
  userTechniques   UserTechnique[]
  userItems        UserItem[]
  userCreatures    UserCreature[]
  usernameLookups  UsernameLookup[]

  @@map("user_profiles")
  @@schema("users")
}

model UsernameLookup {
  username String       @id
  userId   String       @map("user_id")
  user     UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usernames")
  @@schema("users")
}

// =============================================================================
// Characters
// =============================================================================

model Character {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  data      Json     // Full character document (name, level, abilities, powers, etc.)
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@index([userId])
  @@index([userId, updatedAt])
  @@map("characters")
  @@schema("users")
}

// =============================================================================
// User Library
// =============================================================================

model UserPower {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  data      Json     // name, description, parts, damage, actionType, etc.
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@index([userId])
  @@map("user_powers")
  @@schema("users")
}

model UserTechnique {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  data      Json
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@index([userId])
  @@map("user_techniques")
  @@schema("users")
}

model UserItem {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  data      Json
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@index([userId])
  @@map("user_items")
  @@schema("users")
}

model UserCreature {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  data      Json
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@index([userId])
  @@map("user_creatures")
  @@schema("users")
}

// =============================================================================
// Campaigns
// =============================================================================

model Campaign {
  id          String   @id @default(uuid())
  ownerId     String   @map("owner_id")
  name        String
  description String?
  inviteCode  String   @map("invite_code")
  characters  Json     // CampaignCharacter[]
  memberIds   Json     // string[]
  ownerUsername String? @map("owner_username")
  createdAt   DateTime? @map("created_at")
  updatedAt   DateTime? @map("updated_at")

  rolls CampaignRoll[]

  @@index([ownerId])
  @@map("campaigns")
  @@schema("campaigns")
}

model CampaignRoll {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  data       Json     // roll metadata
  createdAt  DateTime? @map("created_at")

  @@index([campaignId])
  @@map("campaign_rolls")
  @@schema("campaigns")
}

// =============================================================================
// Encounters (user-owned encounter tracker data)
// =============================================================================

model Encounter {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  data      Json     // Encounter: name, type, status, combatants, round, skillEncounter, etc.
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@index([userId])
  @@index([userId, updatedAt])
  @@map("encounters")
  @@schema("encounters")
}

// =============================================================================
// Codex / Game Reference Data (from Firestore codex_*)
// =============================================================================

model CodexFeat {
  id     String @id // Document ID from Firestore/CSV
  data   Json
  @@map("codex_feats")
  @@schema("codex")
}

model CodexSkill {
  id     String @id
  data   Json
  @@map("codex_skills")
  @@schema("codex")
}

model CodexSpecies {
  id     String @id
  data   Json
  @@map("codex_species")
  @@schema("codex")
}

model CodexTrait {
  id     String @id
  data   Json
  @@map("codex_traits")
  @@schema("codex")
}

model CodexPart {
  id     String @id
  data   Json   // type: 'power' | 'technique'
  @@map("codex_parts")
  @@schema("codex")
}

model CodexProperty {
  id     String @id
  data   Json
  @@map("codex_properties")
  @@schema("codex")
}

model CodexEquipment {
  id     String @id
  data   Json
  @@map("codex_equipment")
  @@schema("codex")
}

model CodexArchetype {
  id     String @id
  data   Json
  @@map("codex_archetypes")
  @@schema("codex")
}

model CodexCreatureFeat {
  id     String @id
  data   Json
  @@map("codex_creature_feats")
  @@schema("codex")
}

// =============================================================================
// Public Library (admin-curated, browsable by all users)
// Structure mirrors user library; write via admin server actions only
// =============================================================================

model PublicPower {
  id        String   @id @default(uuid())
  data      Json     // Same shape as UserPower.data
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@map("public_powers")
  @@schema("codex")
}

model PublicTechnique {
  id        String   @id @default(uuid())
  data      Json
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@map("public_techniques")
  @@schema("codex")
}

model PublicItem {
  id        String   @id @default(uuid())
  data      Json
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@map("public_items")
  @@schema("codex")
}

model PublicCreature {
  id        String   @id @default(uuid())
  data      Json
  createdAt DateTime? @map("created_at")
  updatedAt DateTime? @map("updated_at")

  @@map("public_creatures")
  @@schema("codex")
}
