rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Base user doc
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Character subcollection
    match /users/{uid}/character/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Other user libraries
    match /users/{uid}/library/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /users/{uid}/itemLibrary/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /users/{uid}/techniqueLibrary/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /users/{uid}/creatureLibrary/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /users/{uid}/encounters/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Shared global library (if needed)
    match /library/{docId} {
      allow read, write: if request.auth != null;
    }

    match /usernames/{username} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Codex / Game reference data — public read, write via Admin SDK only
    match /codex_feats/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_skills/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_species/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_traits/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_parts/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_properties/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_equipment/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_archetypes/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /codex_creature_feats/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Admin config — no client access; Admin SDK used by server
    match /config/{docId} {
      allow read, write: if false;
    }

    // Campaigns - users can read campaigns they own or are members of
    match /campaigns/{campaignId} {
      allow read: if request.auth != null
        && (resource.data.ownerId == request.auth.uid
            || request.auth.uid in resource.data.get('memberIds', []));
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null
        && resource.data.ownerId == request.auth.uid;

      // Campaign roll log - shared rolls from character sheets
      match /rolls/{rollId} {
        allow read, create: if request.auth != null
          && (get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == request.auth.uid
              || request.auth.uid in get(/databases/$(database)/documents/campaigns/$(campaignId)).data.get('memberIds', []));
        allow delete: if request.auth != null
          && (get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == request.auth.uid
              || request.auth.uid in get(/databases/$(database)/documents/campaigns/$(campaignId)).data.get('memberIds', []));
      }
    }
  }
}
